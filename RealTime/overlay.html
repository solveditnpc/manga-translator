<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Translation Overlay</title>
  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      background: rgba(0,0,0,0);
      cursor: crosshair;
      user-select: none;
    }
    #selection {
      position: absolute;
      border: 1px solid #00aaff;
      background: rgba(0,0,0,0);
      display: none;
    }
    #previews-container {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none; /* Allows clicks to pass through */
    }
    .preview-image {
      position: absolute;
      border: 1px solid #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    .loading-indicator {
      position: absolute;
      color: white;
      background: rgba(0,0,0,0.5);
      padding: 5px;
      border-radius: 3px;
      font-family: sans-serif;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="selection"></div>
  <div id="previews-container"></div>

  <script>
    const { ipcRenderer } = require('electron');

    const sel = document.getElementById('selection');
    const previewsContainer = document.getElementById('previews-container');
    let startX = 0, startY = 0, isDragging = false;

    // --- Selection Logic ---
    document.addEventListener('mousedown', (e) => {
      isDragging = true;
      startX = e.pageX;
      startY = e.pageY;
      sel.style.left = startX + 'px';
      sel.style.top = startY + 'px';
      sel.style.width = '0px';
      sel.style.height = '0px';
      sel.style.display = 'block';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      sel.style.left = Math.min(startX, e.pageX) + 'px';
      sel.style.top = Math.min(startY, e.pageY) + 'px';
      sel.style.width = Math.abs(e.pageX - startX) + 'px';
      sel.style.height = Math.abs(e.pageY - startY) + 'px';
    });

    document.addEventListener('mouseup', (e) => {
      if (!isDragging) return;
      isDragging = false;
      sel.style.display = 'none';

      const region = {
        x: parseInt(sel.style.left, 10),
        y: parseInt(sel.style.top, 10),
        width: parseInt(sel.style.width, 10),
        height: parseInt(sel.style.height, 10),
      };

      if (region.width < 5 || region.height < 5) return;

      const captureId = `capture_${Date.now()}`;
      
      // Show a temporary loading indicator
      const loading = document.createElement('div');
      loading.id = `loading_${captureId}`;
      loading.className = 'loading-indicator';
      loading.textContent = 'Translating...';
      loading.style.left = region.x + 'px';
      loading.style.top = region.y + 'px';
      previewsContainer.appendChild(loading);

      // Send region to main process
      ipcRenderer.send('region-selected', { region, id: captureId });
    });

    // --- Listen for completed translations ---
    ipcRenderer.on('translation-complete', (event, { id, originalRegion, translatedImagePath }) => {
      // Remove the loading indicator
      const loading = document.getElementById(`loading_${id}`);
      if (loading) loading.remove();

      // Create a new image element for the translated text
      const newImg = document.createElement('img');
      newImg.src = translatedImagePath;
      newImg.className = 'preview-image';
      
      // Position it exactly where the original text was
      newImg.style.left = originalRegion.x + 'px';
      newImg.style.top = originalRegion.y + 'px';
      newImg.style.width = originalRegion.width + 'px';
      newImg.style.height = originalRegion.height + 'px';

      previewsContainer.appendChild(newImg);
    });

    // Press 'Esc' to close the entire application
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        ipcRenderer.send('return-to-starter');
      }
    });
  </script>
</body>
</html>